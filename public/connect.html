<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conex√£o WhatsApp - Scanner de QR Code</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Define a fonte Inter como padr√£o */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            /* Fundo cinza claro */
            /* üõë CORRE√á√ÉO CR√çTICA: Esconde o corpo at√© que a autentica√ß√£o seja verificada. */
            display: none;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        /* Estilo para a anima√ß√£o de rota√ß√£o */
        .animate-spin {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>

    <div id="app-container" class="w-full max-w-lg p-6 md:p-10 bg-white shadow-2xl rounded-xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-extrabold text-gray-900">Conex√£o WhatsApp</h1>
            <p id="status-message" class="mt-2 text-gray-600 font-medium transition-all duration-300">
                Aguardando status inicial do servidor...
            </p>
        </header>

        <div id="status-display"
            class="flex flex-col items-center justify-center p-6 bg-gray-50 border border-gray-200 rounded-lg min-h-60 transition-all duration-500 ease-in-out">

            <div id="loading-indicator" class="flex items-center space-x-3">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-500"></div>
                <p class="text-lg text-indigo-600 font-semibold">Iniciando Servi√ßo...</p>
            </div>

            <div id="qr-code-section" class="hidden flex flex-col items-center">
                <p class="mb-4 text-center text-gray-700">Escaneie o QR Code com seu celular para conectar.</p>
                <img id="qr-code-image" src="" alt="QR Code para Conex√£o WhatsApp"
                    class="w-64 h-64 border-4 border-indigo-500 rounded-lg shadow-xl"
                    onerror="this.onerror=null; this.src='https://placehold.co/256x256/f7f7f7/333?text=QR+Code+Indispon√≠vel';" />
                <p class="mt-2 text-sm text-red-500 font-medium">Este c√≥digo expira rapidamente!</p>
            </div>

            <div id="connected-section" class="hidden flex flex-col items-center text-center p-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-green-500 mb-4" viewBox="0 0 20 20"
                    fill="currentColor">
                    <path fill-rule="evenodd"
                        d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                        clip-rule="evenodd" />
                </svg>
                <h2 class="text-2xl font-bold text-green-600">Conectado com Sucesso!</h2>
                <p class="mt-1 text-gray-600">Voc√™ pode fechar esta p√°gina. A sess√£o est√° ativa.</p>
            </div>

            <div id="error-section" class="hidden flex flex-col items-center text-center p-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-red-500 mb-4" viewBox="0 0 20 20"
                    fill="currentColor">
                    <path fill-rule="evenodd"
                        d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
                        clip-rule="evenodd" />
                </svg>
                <h2 class="text-xl font-bold text-red-600">Conex√£o Perdida</h2>
                <p class="mt-1 text-gray-600">Ocorreu um erro ou a sess√£o expirou. Tentando novamente em breve...</p>
                <p id="retry-message" class="mt-2 text-sm text-gray-500">Tentativa 0 de 5.</p>
            </div>

        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // üõë VARI√ÅVEL DE CONFIGURA√á√ÉO CR√çTICA
        const LOGIN_URL = 'loginqrcode.html';



        // Vari√°veis globais do ambiente (MANDAT√ìRIO)
        const appId = 'default-app-id'; // Pode manter o default
        const firebaseConfig = JSON.parse('__FIREBASE_CONFIG_PLACEHOLDER__');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Elementos da UI
        const statusMessage = document.getElementById('status-message');
        const loadingIndicator = document.getElementById('loading-indicator');
        const qrCodeSection = document.getElementById('qr-code-section');
        const qrCodeImage = document.getElementById('qr-code-image');
        const connectedSection = document.getElementById('connected-section');
        const errorSection = document.getElementById('error-section');
        const retryMessage = document.getElementById('retry-message');

        // Vari√°veis de controle de Polling e Backoff
        let isPollingActive = true;
        let retryCount = 0;
        const maxRetries = 5;
        const baseIntervalMs = 3000; // 3 segundos como intervalo base para polling/retry

        let auth;
        let db;
        let userId;

        /**
         * Atualiza a UI com base no status.
         */
        function updateUI(status, data, errorDetail = null) {
            // Esconde todas as se√ß√µes por padr√£o
            loadingIndicator.classList.add('hidden');
            qrCodeSection.classList.add('hidden');
            connectedSection.classList.add('hidden');
            errorSection.classList.add('hidden');

            switch (status) {
                case 'loading':
                case 'qr_waiting':
                    statusMessage.textContent = 'Aguardando o QR Code...';
                    loadingIndicator.classList.remove('hidden');
                    break;
                case 'qr_code':
                    // **PONTO CR√çTICO**: Injeta a string Base64 no atributo src da tag <img>
                    if (data && data.qrCodeBase64) {
                        qrCodeImage.src = data.qrCodeBase64;
                    } else {
                        qrCodeImage.src = 'https://placehold.co/256x256/f7f7f7/333?text=QR+Code+Indispon√≠vel';
                    }
                    statusMessage.textContent = 'Por favor, escaneie o c√≥digo abaixo.';
                    qrCodeSection.classList.remove('hidden');
                    retryCount = 0; // Resetar retries ap√≥s sucesso na comunica√ß√£o
                    break;
                case 'connected':
                    statusMessage.textContent = 'Conex√£o estabelecida com sucesso!';
                    connectedSection.classList.remove('hidden');
                    isPollingActive = false; // Parar polling
                    break;
                case 'error':
                case 'disconnected':
                    statusMessage.textContent = 'Ocorreu um erro ou a sess√£o expirou.';
                    errorSection.classList.remove('hidden');

                    if (errorDetail) {
                        console.error("Detalhes do Erro:", errorDetail);
                    }
                    break;
                default:
                    statusMessage.textContent = 'Status desconhecido: ' + status;
                    errorSection.classList.remove('hidden');
            }
        }

        /**
         * Faz a chamada real √† API do backend para verificar o status de conex√£o.
         */
        async function checkConnectionStatus() {
            if (!isPollingActive) {
                return;
            }

            // Endpoint real
            const apiEndpoint = `/api/whatsapp/status?userId=${userId}`;

            try {
                // Notifica que estamos checando, se n√£o estiver j√° no estado QR Code ou Connected
                if (qrCodeSection.classList.contains('hidden') && connectedSection.classList.contains('hidden')) {
                    statusMessage.textContent = 'Verificando status de conex√£o...';
                    loadingIndicator.classList.remove('hidden');
                }

                const response = await fetch(apiEndpoint, { method: 'GET' });

                if (!response.ok) {
                    // Lidar com status HTTP que indicam falha (ex: 404, 500)
                    throw new Error(`Erro HTTP: ${response.status} ${response.statusText}`);
                }

                const apiResponse = await response.json();

                // O backend deve retornar o status de forma limpa (qr_code, connected, etc.)
                const status = apiResponse.status || 'error';
                const qrData = apiResponse;

                updateUI(status, qrData);

                // Se o status final (connected, disconnected, error) n√£o foi alcan√ßado,
                // continuar o polling ap√≥s um intervalo fixo.
                if (status !== 'connected' && status !== 'disconnected') {
                    // Intervalo normal de polling
                    setTimeout(checkConnectionStatus, baseIntervalMs);
                }

            } catch (error) {
                console.error("Erro ao verificar status da API:", error);

                // L√≥gica de Exponential Backoff
                if (retryCount < maxRetries) {
                    retryCount++;

                    // Calcular tempo de espera exponencialmente
                    const delay = baseIntervalMs * Math.pow(2, retryCount - 1);

                    updateUI('error', null, error.message);
                    retryMessage.textContent = `Tentativa ${retryCount} de ${maxRetries}. Pr√≥xima em ${Math.round(delay / 1000)}s.`;

                    // Agendar a pr√≥xima tentativa
                    setTimeout(checkConnectionStatus, delay);
                } else {
                    // Retries esgotados. Parar o polling e mostrar erro final.
                    isPollingActive = false;
                    updateUI('disconnected', null, "M√°ximo de tentativas de conex√£o esgotado. Verifique o servidor.");
                    retryMessage.textContent = 'N√£o foi poss√≠vel reconectar. Por favor, atualize a p√°gina.';
                }
            }
        }

        /**
         * Inicializa o Firebase e come√ßa o processo de autentica√ß√£o.
         */
        async function initApp() {
            try {


                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                updateUI('loading'); // Come√ßar mostrando o loading

                // Autentica√ß√£o com o token ou an√≥nima
                const performAuth = async () => {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        // N√£o force signInAnonymously se for uma rota protegida por login/senha,
                        // pois a sess√£o j√° deve existir se o loginqrcode.html foi usado.
                        // Manter o onAuthStateChanged √© suficiente para pegar a sess√£o existente.
                    }
                };

                // Executa a autentica√ß√£o se houver um token personalizado
                if (initialAuthToken) {
                    await performAuth();
                }

                // üõë CORRE√á√ÉO CR√çTICA: L√≥gica de Prote√ß√£o de Rota
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        // ‚úÖ Usu√°rio autenticado
                        userId = user.uid;
                        console.log("Usu√°rio autenticado:", userId);

                        // üü¢ EXIBE O CORPO AGORA QUE EST√Å LOGADO
                        document.body.style.display = 'flex';

                        // Inicia o processo de polling ap√≥s a autentica√ß√£o
                        checkConnectionStatus();
                    } else {
                        // ‚ùå Usu√°rio N√ÉO autenticado
                        console.error("Acesso negado. Redirecionando para login.");

                        // üõë REDIRECIONAMENTO DE SEGURAN√áA
                        window.location.href = LOGIN_URL;
                    }
                });

            } catch (error) {
                console.error("Erro na inicializa√ß√£o do Firebase ou Auth:", error);

                // üõë CORRE√á√ÉO CONTRA TELA BRANCA:
                // Se a inicializa√ß√£o falhar (devido a JSON inv√°lido ou config incorreta),
                // for√ßamos a exibi√ß√£o para mostrar a UI de erro.
                document.body.style.display = 'flex';

                updateUI('error', null, error.message);
            }
        }

        // Inicia a aplica√ß√£o quando a janela carregar
        initApp();

    </script>
</body>

</html>
